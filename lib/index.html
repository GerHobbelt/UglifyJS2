<!DOCTYPE html>
<html>
	<head>
		<title>ColaScript Playground</title>
		<script src="./utils.js"></script>
    	<script src="./ast.js"></script>
    	<script src="./parse.js"></script>
    	<script src="./transform.js"></script>
    	<script src="./scope.js"></script>
    	<script src="./output.js"></script>
    	<script src="./compress.js"></script>
    	<script src="./sourcemap.js"></script>
    	<script src="./mozilla-ast.js"></script>
    	<script src="./translate.js"></script>
    	<script src="./std.js"></script>
    	<style>
    	
    	body {
    	    padding: 0; 
    	    margin: 0; 
    	    line-height: 100%; 
    	    position: fixed; 
    	    top: 0; 
    	    left: 0; 
    	    width: 100%; 
    	    height: 100%;
    	}
    	
    	textarea {
    		box-sizing: border-box;
    	    width: 33.333%; 
    	    height: 100%; 
    	    font-size: 12px; 
    	    float: left;
    	    font-family: "Andale Mono";
    	}

    	#controls {
    		position: fixed;
    		bottom: 0;
    		left: 0;
            height: 25px;
            width: 100%;
    	}

        #controls .m {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #controls .bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            opacity: 0.5;
        }
    	
    	</style>
	</head>
	<body>
		<textarea id="source" onkeyup="compile()">main(){
    console.log(`

        Hello!
        My name is ColaScript, and i know who you are }:->
        @{navigator.userAgent}

    `);

    console.log("pow:", 5 ** 2, "; modulo:", 5 %% 3, ";");

    Number a = 3.14, b = 584, c;

    a ?= b; console.log(a);
    a = undefined;
    a ?= b; console.log(a);

    console.log(a = c ? b);
    c = 404;
    console.log(a = c ? b);

    b = undefined;

    Array x, y;
    x = [123];
    y = clone x;
    y[] = 321;
    console.log('original:',x,'cloned:',y, y[]);

    y[0..1] = [1..10];
    console.log(y[0..4]);

    y.forEach((val) => console.log(val));

    console.log("a is {{isset a ? 'set' : 'undefiend'}}, b is {{b?? ? 'set' : 'undefined'}}");

    console.log(`is:`, location.href is String, `; isnt:`, 123 isnt Number, ";");

    if(yes === true && on === true && no === false && off === false) console.log('Boolean alternatives');

    console.log('Raw string:', r`@test \n \t \r`);
    RegExp isEmail = /
        ([\w-\.]+)
        @
        ((?:[\w]+\.)+)
        ([a-zA-Z]{2,4})
    /, email = r'danon0404@gmail.com';
    console.log("@email is email:", isEmail.test(email));
}

main();</textarea>
		<textarea id="translation"></textarea>
		<textarea id="result"></textarea>
		<div id="controls">  
            <div class="bg">&nbsp;</div>
            <div class="m">
                <button id="exec" onclick="exec()">Execute</button>
                <button id="benchmark" onclick="benchmark()">Benchmark</button>
                <input type="checkbox" id="is_js" onclick="compile()">
                <label for="is_js">js parser</label>
                <span id="lenstat"></span>
            </div>
	</body>
	<script>
		var sourceArea = document.getElementById("source"), 
			translationArea = document.getElementById("translation"), 
			resultArea = document.getElementById("result"), 
            isjs = document.getElementById("is_js"),
			source;

        if(!localStorage.source) localStorage.source = source = sourceArea.value;
		else sourceArea.value = source = localStorage.source;
        isjs.checked = localStorage.isjs == "t";

		function compile(){
			source = sourceArea.value;
			localStorage.source = source;
            localStorage.isjs = isjs.checked ? "t" : "f";

			stream = new Cola.OutputStream({ beautify : true });
			compressor = new Cola.Compressor({ is_js : isjs.checked });

			try {
				// 1. compile
				ast = Cola.parse(source, { is_js : isjs.checked });
				if(!isjs.checked) ast = ast.toJavaScript({ main_binding : false });
				ast.print(stream);
				translationArea.value = stream.toString();

				// 2. compress
        		ast.figure_out_scope();
        		ast = ast.transform(compressor);

    			// 3. mangle
        		ast.figure_out_scope();
        		ast.compute_char_frequency();
        		ast.mangle_names({ sort : true, toplevel : true });

        		stream = new Cola.OutputStream();
        		ast.print(stream);
				resultArea.value = stream.toString();
			} catch(e){
				translationArea.value = '';
				resultArea.value = '';

                throw e;
			}

            document.querySelector('#lenstat').innerHTML = sourceArea.value.length+" : "+translationArea.value.length+" : "+resultArea.value.length;
		}

        function benchmark(){
            console.time("Uncompressed");
            eval(translationArea.result);
            console.timeEnd("Uncompressed");

            console.time("Compressed");
            eval(resultArea.result);
            console.timeEnd("Compressed");
        }

		function exec(){
			eval(resultArea.value)
		}

		function Translate(){
			stream = new Cola.OutputStream({ beautify : true });
			translate(Cola.parse(source, null, isjs.checked)).print(stream);
			return stream.toString();
		}

		compile();
	</script>
</html>
